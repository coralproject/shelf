{
  "name":"spending_advice",
  "description":"tests against user spending rate and provides adequate advice on saving more",
  "enabled": true,
  "params":[
    {
      "name":"user_id",
      "default":"396bc782-6ac6-4183-a671-6e75ca5989a5",
      "desc":"provides the user_id to check against the collection"
    }
  ],
  "rules": [
  {
    "desc":"match spending rate over 20 dollars",
    "type":"pipeline",
    "continue": true,
    "script_options": {
      "collection":"demo_user_transactions",
      "has_date":false,
      "has_objectid": false
    },
    "save_options": {
      "save_as":"high_dollar_users",
      "variables": true,
      "to_json": true
    },
    "var_options":{},
    "scripts":[
      "{ \"$match\" : { \"user_id\" : \"#userId#\", \"category\" : \"gas\" }}",
      "{ \"$group\" : { \"_id\" : { \"category\" : \"$category\" }, \"amount\" : { \"$sum\" : \"$amount\" }}}",
      "{ \"$match\" : { \"amount\" : { \"$gt\" : 20.00} }}"
    ]
   },
  {
    "desc":"retrieving spending advice",
    "type":"pipeline",
    "continue": false,
    "script_options": {
      "collection":"demo_advice",
      "has_date":false,
      "has_objectid": false
    },
    "save_options": {
      "save_as":"spending_advice",
      "variables": true,
      "to_json": true
    },
    "var_options":{},
    "script":[
        "{ \"$match\" : { \"advice_id\" : 1 }}"
    ]
  }]
}
